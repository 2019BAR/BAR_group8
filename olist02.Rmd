---
title: OLIST02：多重軸度比較圖
author: 中山大學管理學院 卓雍然
date: "`r Sys.time()`"
output: 
  html_document:
    highlight: pygments
    theme: flatly
    css: ../style.css
---

```{r results='hide', message=FALSE, warning=FALSE, echo=F}
# 這些程式碼設定網頁的格式，並安裝、載入一些基本的套件，請大家不要去改動<br>
rm(list=ls(all=T))
knitr::opts_chunk$set(comment = NA)
knitr::opts_knit$set(global.par = TRUE)
par(cex=0.8)
options(scipen=20, digits=5, width=80)
if(!require(googleVis)) install.packages("googleVis")
if(!require(pacman)) install.packages("pacman")
```
<hr>

<br>
```{r results='hide', message=FALSE, warning=FALSE}
pacman::p_load(dplyr, ggplot2, readr, plotly, googleVis)
```

```{r}
load("data/olist.rdata")
load("data/Z.rdata")
```
<br><hr>

### A. 基本繪圖套件 `ggplot`
```{r}
ggplot(segment, aes(x=log(avgItemsSold), y=avgPrice, col=avgScore)) +
  geom_point(aes(size=sqrt(noSellers))) +
  geom_text(aes(label=business_segment), size=3)
```
<br><hr>

### B. 互動式繪圖套件 `ggplotly`
```{r}
g = ggplot(segment, aes(x=log(avgItemsSold), y=avgPrice, col=avgScore)) +
  geom_point(aes(size=sqrt(noSellers))) +
  geom_text(aes(label=business_segment), size=0.5)
ggplotly(g)
```
<br><hr>

### C. 互動式多軸度泡泡圖 `googleVis`

##### 最簡單的做法
```{r results='asis', tidy=FALSE, eval=F}
# op = options(gvis.plot.tag='chart')
segment$year = 2018
gvisMotionChart(segment, "business_segment", "year") %>% plot
```
<br>

##### 稍微複雜的案例
Merge `TPC$product_category_name_english` into `P` as `P$category`
```{r}
P = left_join(P, TPC) %>% rename(category = product_category_name_english)
```

Merge `P$category into `I`
```{r}
I = left_join(I, P[,c(1,10)])
```

Summerise by `category`
```{r}
category = filter(I, !is.na(category)) %>% 
  group_by(category) %>% summarise(
    itemsSold = n(),
    totalRev = sum(price),
    avgPrice = mean(price),
    noProduct = n_distinct(product_id),
    noSeller = n_distinct(seller_id),
    dummy = 2018
  ) %>% arrange(desc(totalRev))
```

Top-20 categories
```{r}
top20 = category %>% top_n(20, totalRev)
top20
```

**靜態多軸互動**
```{r results='asis', tidy=FALSE, eval=F}
gvisMotionChart(category, "category", "dummy") %>% plot
```

##### 時間面板資料 Panel Data
併入時間資料
```{r}
X = left_join(O[, c(1,4)], R[,2:3]) %>%     # pull score & timestamp into 'O'
  rename(
    time = order_purchase_timestamp, 
    score = review_score) %>% 
  mutate(                                   # cut timestamp into quarter    
    quarter = as.Date(cut(time, "quarter"))
    ) %>%  
  right_join(I) %>%                         # merge score & quarter into 'I'
  filter(category %in% top20$category) %>%  # pick out the top20 categories
  group_by(category, quarter) %>% 
  summarise(                            # summarise by category & quarter
    itemsSold = n(),                     
    totalRev = sum(price),
    avgPrice = mean(price),
    avgScore = mean(score),
    noProduct = n_distinct(product_id),
    noSeller = n_distinct(seller_id)
  ) %>% 
  arrange(category, quarter)            # order by category & quarter
```

調整資料範圍、去除離群值
```{r}
X2 = X %>%  # adjustment before ploting
  filter(quarter >= as.Date("2017-04-01")) %>% 
  filter(!(category %in% c("computers", "office_furniture"))) %>% 
  mutate(avgPrice = pmax(avgPrice, 3)) %>% as.data.frame
```

**動態多軸互動**
```{r results='asis', tidy=FALSE, eval=F}
gvisMotionChart(X2, "category", "quarter") %>% plot
```

<br><br><hr>

本組原先思考是否可以從營收佔比最多的幾家企業出發，去探討為何這幾家企業能夠有如此高的營收佔比，以及如何維持和使其成長，為平台帶來效益。

```{r}
# Z$pcgRev = 100 * Z$rev / sum(Z$rev)

Z = Z %>% mutate(
  pcgRev = 100 * Rev / sum(Rev),
  cumPcg = cumsum(pcgRev)
  ) %>% arrange(desc(pcgRev))
```

```{r}
View(Z[,18:19])
```


```{r fig.height=15}
#各企業的總營收佔比分布圖
barplot(Z$pcgRev[1:30], horiz=T)
```
    由上圖我們發現，各家企業的營收佔比其實差距不大，最多甚至不超過0.5%，也就是說沒有非常顯著的營收佔比優勢企業，因此我們預期對營收佔比最多的幾家企業進行分析對平台能帶來的效益有限，在考量之下我們思考了其他的分析角度。

本組目前分析角度：

由segment的資料當中我們發現一共有29種的商品類別，而總營收最多的前三個類別已超過整個平台總營收的三分之一了，本組認為可以由此切入點出發，進一步分析為何這三類產品營收如此高，和如何維持甚至使其穩定成長，站在平台方角度思考如何增進熱門類別產品的銷售，並提出策略建議來為平台帶來效益。

預計分析流程：

step1：找出平台產品類別

```{r}
#從數據中看出，平台上的產品配別總共有71項，由於我們要找出總營收佔整個平台前30%的產品類別，所以先取出銷售額前10高的產品類別
str(category)
```


step2：取出總營收佔整個平台前30%的產品類別

```{r}
top10 = category %>% top_n(10, totalRev)
top10
```

```{r}
#取出前4個類別的產品，其佔比總銷售額約1/3，故我們針對這4個類別各別分析
round(sum(category$totalRev[1:4]) / sum(category$totalRev), 3)
```

step3：按月營比較該類別產品當年度與去年度的異同(該類別熱賣期間)

```{r}
Monthly = left_join(O[, c(1,4)], I[,1:8]) %>%     # pull score & timestamp into 'O'
  rename(
    time = order_purchase_timestamp, 
    ) %>% 
  mutate(                                   # cut timestamp into quarter    
    month = as.Date(cut(time, "month")),
    ) %>%  
  right_join(I) %>%                         # merge score & quarter into 'I'
  filter(category %in% top20$category) %>%  # pick out the top20 categories
  group_by(category, month) %>% 
  summarise(                            # summarise by category & quarter
    itemsSold = n(),                     
    totalRev = sum(price),
    avgPrice = mean(price),
    noProduct = n_distinct(product_id),
    noSeller = n_distinct(seller_id)
  ) %>% 
  arrange(category, month)
Monthly
```



```{r}
cat_health_beauty = Monthly %>% filter(category == "health_beauty")
cat_watches_gifts = Monthly %>% filter(category == "watches_gifts")
cat_bed_bath_table = Monthly %>% filter(category == "bed_bath_table")
cat_sports_leisure = Monthly %>% filter(category == "sports_leisure")
```


```{r}
plot(cat_health_beauty$month, cat_health_beauty$totalRev, type='l', col='orange', xlim=as.Date(c('2017-01-01','2018-08-01'))) 

lines(cat_watches_gifts$month, cat_watches_gifts$totalRev, type='l', col='pink')
lines(cat_bed_bath_table$month, cat_bed_bath_table$totalRev, type='l', col='green')
lines(cat_sports_leisure$month, cat_sports_leisure$totalRev, type='l', col='blue') +
  abline(v=as.Date(c("2017-01-01","2017-02-01","2017-03-01")),col='gray',lty=3)

```

```{r}
adjust_Monthly = left_join(I[,1:8], R[,2:3]) %>%   
  rename(
    score = review_score) %>% 
  right_join(I) %>%                         # merge score & quarter into 'I'
  filter(category %in% top10$category) %>%  # pick out the top20 categories
  group_by(category) %>% 
  summarise(                            # summarise by category & quarter
    itemsSold = n(),                     
    totalRev = sum(price),
    avgPrice = mean(price),
    noProduct = n_distinct(product_id),
    noSeller = n_distinct(seller_id),
    avg_score = mean(score)
  ) %>% 
  arrange(desc(totalRev))
top_4_Monthly = adjust_Monthly %>% filter(totalRev > 950000)
top_4_Monthly
```

```{r}
gg =  ggplot(top_4_Monthly, aes(x=log(itemsSold), y=log(totalRev), col=category)) +
  geom_point(aes(size=avg_score)) +
  geom_text(aes(label=category), size=3)
ggplotly(gg)
```

```{r}
category_without_city = left_join(O[, c(1,2,4)], I[,1:8]) %>%
  right_join(I)    

category_with_city = left_join(category_without_city[,1:10], C[,1:5]) %>% right_join(category_without_city)

category_with_city %>% filter(category == "health_beauty")

```


step4：該類別產品消費者地區組成

step5：該類別產品熱賣區域物流狀況與運費占比

step6：是否有消費組合或替代品的存在

step7：提出策略建議和可行方案

